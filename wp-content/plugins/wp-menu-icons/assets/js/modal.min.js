(function(b){b.fn.serializeArrayAll=function(){var c=/\r?\n/g;return this.map(function(){return this.elements?jQuery.makeArray(this.elements):this}).map(function(d,e){var f=jQuery(this).val();if(f==null){return f==null}else{if(this.type=="checkbox"&&this.checked==false){return{name:this.name,value:this.checked?this.value:""}}else{return jQuery.isArray(f)?jQuery.map(f,function(h,g){return{name:e.name,value:h.replace(c,"\r\n")}}):{name:e.name,value:f.replace(c,"\r\n")}}}}).get()};var a={__instance:undefined};a.Application=Backbone.View.extend({id:"wpmi_modal",events:{"click .close":"Close","click .remove":"Remove","click .save":"Save","click .attachments .attachment":"Select","keyup #media-search-input":"Search",},ui:{nav:undefined,content:undefined,media:undefined},templates:{},initialize:function(c){_.bindAll(this,"render","preserveFocus","Search","Select","Close","Save","Remove");this.initialize_templates();this.render(c);this.backdrop(c);this.tabs(c)},backdrop:function(d){var c=this;b(document).on("click",".media-modal-backdrop",function(f){c.Close(f)})},tabs:function(d){var c=this;b(document).on("click",".media-modal-backdrop",function(f){c.Close(f)})},initialize_templates:function(){this.templates.window=wp.template("wpmi-modal-window");this.templates.backdrop=wp.template("wpmi-modal-backdrop");this.templates.preview=wp.template("wpmi-modal-preview");this.templates.settings=wp.template("wpmi-modal-settings")},render:function(f){var g=b(f.target).closest("li"),d=parseInt(g.prop("id").match(/menu-item-([0-9]+)/)[1]),c={};b(f.target).closest("li").find("input.wpmi-input").each(function(h){var e=b(this).prop("id").match(/wpmi-input-([a-z]+)/)[1],j=b(this).val();c[e]=j});this.$el.attr("tabindex","0").data("menu_item_id",d).append(this.templates.window()).append(this.templates.backdrop());this.ui.preview=this.$(".media-sidebar").append(this.templates.preview(c));this.ui.settings=this.$(".media-sidebar").append(this.templates.settings(c));this.ui.settings.find("#wpmi-input-color").wpColorPicker();b(document).on("focusin",this.preserveFocus);b("body").addClass("modal-open").append(this.$el);this.$el.focus()},preserveFocus:function(c){if(this.$el[0]!==c.target&&!this.$el.has(c.target).length){this.$el.focus()}},Search:function(f){var d=b(f.target),c=this.$el.find(".attachments .attachment");d.on("keyup",function(g){g.preventDefault();setTimeout(function(){var e=d.val();if(e!==""){c.css({display:"none"});c.filter('[class*="'+e+'"]').css({display:"block"})}else{c.removeAttr("style")}},600)})},Select:function(h){var g=b(h.target),c=this.$el.find(".media-sidebar .filename"),f=this.$el.find(".media-sidebar .thumbnail > i"),i=this.$el.find('input[name="wpmi[icon]"]'),d=g.find("i").attr("class");c.text(d);i.val(d);f.removeAttr("class").addClass(d)},Close:function(c){c.preventDefault();this.undelegateEvents();b(document).off("focusin");b("body").removeClass("modal-open");this.remove();a.__instance=undefined},Save:function(i){i.preventDefault();var h=this,d=b("form",this.$el),f=this.$el.data("menu_item_id");if(!f){return}if(!d.length){return}var j=b("#menu-to-edit").find("#menu-item-"+f),g=j.find(".menu-item-wpmi_plus"),c=j.find(".menu-item-wpmi_icon");if(!j.length){return}d.find(".wpmi-input").each(function(k){var e=b(this).prop("id").match(/wpmi-input-([a-z]+)/)[1],l=b(this).val();j.find("input#wpmi-input-"+e).val(l);if(e==="icon"){if(c.length){c.remove()}g.before('<i class="menu-item-wpmi_icon '+l+'"></i>')}});h.Close(i)},Remove:function(h){h.preventDefault();var g=this,d=b("form",this.$el),f=this.$el.data("menu_item_id");if(!f){return}if(!d.length){return}var i=b("#menu-to-edit").find("#menu-item-"+f),c=i.find(".menu-item-wpmi_icon");if(!i.length){return}d.find(".wpmi-input").each(function(j){var e=b(this).prop("id").match(/wpmi-input-([a-z]+)/)[1];i.find("input#wpmi-input-"+e).val("")});c.remove();g.Close(h)}});b(document).on("click",".menu-item-wpmi_open",function(c){c.preventDefault();if(a.__instance===undefined){a.__instance=new a.Application(c)}});b(document).on("click","#wpmi_metabox",function(f){var d=b("input:checked",b(this)).val(),c=b("#menu").val();if(b(f.target).hasClass("save")&&d&&c){f.preventDefault();b.ajax({type:"POST",url:ajaxurl,data:{action:"wpmi_save_nav_menu",menu_id:c,menu_font:d,nonce:wpmi_l10n.nonce},beforeSend:function(){},complete:function(){},error:function(){alert("Error!")},success:function(e){location.reload()}})}})})(jQuery);